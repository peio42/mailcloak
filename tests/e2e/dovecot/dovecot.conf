dovecot_config_version = 2.4.0
dovecot_storage_version = 2.4.0

protocols = imap lmtp
listen = *


auth_username_format = %{user | username}
mail_home = /var/mail/%{user | username}
mail_driver = maildir
mail_path = ~

mail_uid = 1000
mail_gid = 1000

auth_mechanisms = plain login oauthbearer xoauth2

# OIDC user: AUTH XOAUTH2/OAUTHBEARER -> Keycloak introspection
oauth2 {
  introspection_url = http://mailcloak-admin:mailcloak-admin-secret@keycloak:8080/realms/test/protocol/openid-connect/token/introspect
  introspection_mode = post

  username_attribute = preferred_username
  active_attribute = active
  active_value = true
}

passdb oauth2 {
  mechanisms_filter = oauthbearer xoauth2
}

# Token apps: AUTH PLAIN/LOGIN -> SQLite
passdb sql {
  mechanisms_filter = plain login

  sql_driver = sqlite
  sqlite_path = /var/lib/mailcloak/state.db

  query = SELECT secret_hash AS password \
    FROM apps \
    WHERE app_id = '%{user}' AND enabled = 1;

  passdb_result_failure = return-fail
  passdb_result_internalfail = return-fail
}

# Fallback for LMTP lookups
passdb static {
  fields {
    nopassword = yes
  }

  passdb_skip = authenticated
}

userdb static {
  fields {
    uid = 1000
    gid = 1000
    home = /var/mail/%{user}
  }
}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = root
    group = root
  }
}

service lmtp {
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    mode = 0666
    user = root
    group = root
  }
}
