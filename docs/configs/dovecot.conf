#
# Configuration to add to /etc/dovecot/dovecot.conf
#

auth_mechanisms {
  oauthbearer = yes
  xoauth2 = yes
  plain = yes
  login = yes
}

# OIDC user: AUTH XOAUTH2/OAUTHBEARER -> Keycloak introspection
oauth2 {
  introspection_url = https://<client_id>:<client_secret>@<Keycloak_realm>/protocol/openid-connect/token/introspect
  introspection_mode = post

  username_attribute = preferred_username
  active_attribute = active
  active_value = true
}

passdb oauth2 {
  mechanisms_filter = oauthbearer xoauth2
}

# Token apps: AUTH PLAIN/LOGIN -> SQLite
passdb sql {
  mechanisms_filter = plain login

  sql_driver = sqlite
  sqlite_path = /var/lib/mailcloak/state.db

  query = SELECT secret_hash AS password \
    FROM apps \
    WHERE app_id = '%{user}' AND enabled = 1;

  # In case of failure, do not fallback to other passdbs
  passdb_result_failure = return-fail
  passdb_result_internalfail = return-fail
}

# Fallback for LMTP lookups
passdb static {
  fields {
    nopassword = yes
  }

  # This section is only used for LMTP delivery lookups, not for authentication
  passdb_skip = authenticated
}
